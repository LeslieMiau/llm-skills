## Project Brief
- **Original requirement**: 设计一个量化回测工具，支持 A 股、港股、美股三大市场，能够统一完成策略回测、结果评估与后续扩展。
- **Key constraints**: 需要兼容多市场交易规则差异；回测结果必须可复现；应支持从单机研究到多策略批量回测；优先保证架构可扩展性与数据/撮合正确性，而不是先追求超高频级别性能。
- **Excluded approaches**: 不采用“仅做单市场”的简化方案，因为无法满足跨市场需求；不采用把所有市场规则硬编码在策略里的方案，因为会导致策略不可移植；不采用直接耦合某家券商私有接口作为核心抽象，以避免系统被单一数据源或交易通道绑定。
- **Core decisions**: 采用“统一回测内核 + 市场适配层 + 数据标准化层”的分层架构；事件驱动撮合与向量化预计算混合模式并存；以 Python 为研究入口、Rust/Go 为性能热点预留扩展点；通过统一证券主数据模型屏蔽 A/H/US 市场差异，再由规则引擎处理交易日历、费用、税费、涨跌停、最小价位等市场细节。

# 多市场量化回测工具设计方案 V1

## 1. 目标与设计原则

### 1.1 产品目标
构建一套面向研究和策略验证的量化回测工具，覆盖以下核心能力：

1. 支持 A 股、港股、美股的股票及 ETF 回测。
2. 支持日频、分钟频回测，后续可扩展到更细粒度。
3. 支持单策略交互式研究和批量参数扫描。
4. 支持统一策略接口，策略无需感知市场差异即可复用。
5. 支持现实约束建模，包括滑点、手续费、税费、停牌、涨跌停、T+1/T+0 等。

### 1.2 设计原则
- 正确性优先：撮合与账户核算必须可解释、可审计、可复现。
- 市场隔离：市场规则差异必须集中在规则层，不能散落在策略代码中。
- 分层解耦：数据、策略、执行、分析、存储独立演进。
- 可扩展：未来可增加期货、期权、数字货币，而不推翻核心内核。
- 研究友好：接口贴近量化研究人员习惯，优先支持 Python SDK 与 notebook。

## 2. 典型用户与使用场景

### 2.1 用户画像
- 量化研究员：编写和调试 Alpha、择时、轮动、选股策略。
- 平台工程师：维护数据、调度任务、统一回测环境。
- 投资经理：查看回测指标、归因报告、参数对比结果。

### 2.2 核心场景
1. 在同一策略框架下分别回测 A 股和美股，比较市场适配性。
2. 在同一市场内进行多参数网格搜索，输出收益/回撤/夏普对比。
3. 针对港股、美股引入多币种和汇率折算，评估真实组合净值。
4. 使用分钟线重放交易日内信号，模拟下单、部分成交、冲击成本。

## 3. 系统总体架构

## 3.1 分层架构
建议采用六层结构：

1. 数据接入层（Data Connectors）
2. 数据标准化层（Canonical Data Model）
3. 回测内核层（Backtest Engine）
4. 市场规则层（Market Rule Engine）
5. 分析与报告层（Analytics & Reporting）
6. 任务编排与服务层（Orchestration & API）

### 3.2 组件说明

#### A. 数据接入层
负责接入不同市场的数据源，包括：
- 历史行情：日线、分钟线、逐笔（后续）
- 复权因子：前复权、后复权、拆股、送配、派息
- 交易日历：节假日、半日市、临时停市
- 证券主数据：代码、市场、板块、币种、上市状态
- 公司行为：分红、拆股、配股、退市
- 汇率数据：HKD/CNY、USD/CNY 等

建议采用插件式连接器，统一输出到内部标准格式，避免策略依赖外部源字段。

#### B. 数据标准化层
定义统一数据模型，屏蔽不同市场命名和编码差异。

核心标准对象：
- Instrument：证券基本信息
- Bar：K 线数据
- CorporateAction：公司行为
- TradingCalendar：交易日历
- FXRate：汇率
- MarketMetadata：市场规则元信息

该层负责：
- 代码映射（如 `600519.SH`、`0700.HK`、`AAPL.US`）
- 时区归一（中国时区、香港时区、美东时区）
- 币种标注与净值折算
- 缺失值/停牌数据标记

#### C. 回测内核层
系统核心，负责：
- 时间推进（按 bar / event）
- 信号计算调度
- 订单创建
- 撮合成交
- 账户与持仓更新
- 风控检查
- 指标落盘

建议同时支持两种模式：
- 向量化模式：适合日频选股/资产配置策略，速度快。
- 事件驱动模式：适合分钟级、交易规则复杂、需精细撮合的策略。

二者共享账户模型和市场规则层，避免结果口径不一致。

#### D. 市场规则层
这是多市场支持的关键抽象。每个市场单独维护规则配置和少量定制逻辑：

- A 股：
  - T+1 卖出限制（股票）
  - 涨跌停限制
  - 印花税（卖出）
  - 不同板块最小交易单位差异
  - 停牌与 ST 风险标记

- 港股：
  - T+0
  - 手续费叠加（佣金、交易费、证监会征费、印花税等）
  - 按“每手股数”下单约束
  - 部分股票流动性较差，滑点模型需更保守

- 美股：
  - T+0（按回测建模层面通常可当日卖出）
  - 无涨跌停，但存在熔断/停牌事件
  - 支持碎股（如需模拟）
  - 费用结构与券商模型差异较大，需配置化

实现建议：
- 定义 `MarketRuleProvider` 接口。
- 每个市场实现自己的：
  - `validate_order`
  - `calculate_fee`
  - `can_sell_today`
  - `price_limit_check`
  - `lot_size_rule`
  - `settlement_rule`

#### E. 分析与报告层
输出研究与风控所需指标：
- 收益率、年化收益、最大回撤、Sharpe、Sortino、Calmar
- 换手率、胜率、盈亏比、持仓集中度
- 分市场收益拆分
- 因子暴露/行业暴露（可选）
- 交易明细、持仓曲线、资金曲线
- 基准对比与超额收益

输出形式：
- Python DataFrame
- HTML 报告
- JSON API 结果
- 可视化图表（权益曲线、回撤曲线、月度收益热图）

#### F. 任务编排与服务层
用于把研究型工具升级为团队可复用平台：
- 回测任务提交 API
- 参数扫描任务队列
- 结果缓存与去重
- 任务元数据管理
- 策略版本管理
- 统一权限与审计日志

建议初期采用单体服务，后续将任务调度拆为独立 worker。

## 4. 核心模块设计

### 4.1 策略接口
定义统一策略生命周期：

1. `initialize(context)`：初始化参数、订阅标的、设置基准
2. `before_trading(context)`：盘前处理
3. `on_bar(context, data)`：按 bar 驱动核心逻辑
4. `on_order(context, order_event)`：订单状态更新
5. `after_trading(context)`：盘后统计与落盘

策略只依赖统一接口，不直接依赖市场规则对象；规则差异由引擎注入。

### 4.2 订单与撮合模型
订单类型建议支持：
- Market
- Limit
- VWAP/TWAP（研究模拟）
- TargetPosition（目标仓位单）

撮合模型建议分级：
- Level 1：按下一根 bar 开盘/收盘成交
- Level 2：按 bar 区间撮合，并叠加滑点
- Level 3：基于成交量约束的部分成交

这样既能快速启动，也能逐步提升真实性。

### 4.3 账户模型
统一账户对象应包含：
- 现金（按币种拆分）
- 冻结资金
- 持仓（数量、成本、可卖数量、持仓市值）
- 已实现/未实现盈亏
- 手续费与税费累计
- 保证金字段（为后续衍生品预留）

多币种设计建议：
- 基础记账币种为组合主币种（如 CNY）
- 子账户保留原币种现金
- 每日按汇率快照折算净值

### 4.4 指标计算模块
建议将指标计算和回测执行解耦：
- 执行结束后生成标准化 `BacktestResult`
- 指标模块基于 `BacktestResult` 做二次计算

好处：
- 同一结果可多次生成不同报告
- 便于与外部 BI 系统集成
- 便于回测缓存与重复利用

## 5. 数据模型与存储设计

### 5.1 关键实体

#### Instrument
- `instrument_id`
- `symbol`
- `market` (`CN`, `HK`, `US`)
- `asset_type`
- `currency`
- `lot_size`
- `timezone`
- `listing_date`
- `delisting_date`

#### Bar
- `instrument_id`
- `timestamp`
- `open`
- `high`
- `low`
- `close`
- `volume`
- `turnover`
- `suspend_flag`

#### Order
- `order_id`
- `strategy_run_id`
- `instrument_id`
- `side`
- `order_type`
- `quantity`
- `price`
- `status`
- `created_at`

#### Fill
- `fill_id`
- `order_id`
- `fill_price`
- `fill_quantity`
- `fee`
- `tax`
- `fill_time`

#### PositionSnapshot
- `strategy_run_id`
- `date`
- `instrument_id`
- `quantity`
- `sellable_quantity`
- `avg_cost`
- `market_value`

#### BacktestRun
- `run_id`
- `strategy_id`
- `parameter_hash`
- `market_scope`
- `data_version`
- `engine_version`
- `status`

### 5.2 存储选型建议
- 元数据与任务管理：PostgreSQL
- 大体量行情缓存：Parquet + 对象存储 / 本地列式存储
- 高频中间结果：DuckDB（单机研究）或 ClickHouse（团队扩展）
- 报告与图表产物：对象存储

理由：
- Parquet + DuckDB 非常适合研究场景，成本低，扫描快。
- PostgreSQL 管理任务元数据和配置更稳妥。
- 避免初期引入过重的大数据栈。

## 6. 多市场差异处理策略

### 6.1 统一抽象，不统一规则
核心原则是“策略统一，规则不混同”：
- 策略代码使用统一证券对象和下单接口。
- 回测引擎在执行前查询市场规则层。
- 每笔订单在进入撮合前都经过市场校验。

### 6.2 必须显式建模的市场差异
1. 交易时区与夏令时
2. 交易日历与节假日
3. 最小交易单位（股 / 手 / 碎股）
4. T+0 / T+1 可卖规则
5. 手续费、税费、平台费
6. 涨跌停 / 熔断 / 停牌
7. 复权与公司行为处理
8. 币种与汇率折算

### 6.3 配置驱动示例
建议把大部分规则放入配置：
- `market.yaml`
- `fee_schedule.yaml`
- `holiday_calendar`
- `instrument_lot_rules`

只有少数复杂规则（如 A 股涨跌停判定、港股多层费用）写成代码。

## 7. 技术栈建议

### 7.1 推荐技术方案
- 核心研究语言：Python
- 服务接口：FastAPI
- 任务调度：Celery / RQ（初期二选一）
- 数据分析：Pandas、Polars、PyArrow、DuckDB
- 存储：PostgreSQL + Parquet
- 前端（如需）：React + ECharts/Plotly

### 7.2 性能热点优化
以下模块可能成为瓶颈：
- 分钟级大规模回放
- 参数扫描
- 成交撮合循环
- 多市场大样本指标计算

优化路径：
1. 先用 Python 实现完整正确性闭环。
2. 用 `NumPy/Polars/Numba` 优化热点。
3. 对极端性能瓶颈，再下沉到 Rust 或 Go 扩展。

这样能降低首版复杂度，同时保留上限。

## 8. API 与交互设计

### 8.1 Python SDK（核心入口）
建议提供如下接口：

```python
run_backtest(
    strategy=strategy,
    instruments=["600519.SH", "0700.HK", "AAPL.US"],
    start="2021-01-01",
    end="2024-12-31",
    frequency="1d",
    initial_cash={"CNY": 1000000, "HKD": 200000, "USD": 100000},
    benchmark="SPY",
    market_config="default"
)
```

### 8.2 服务接口
关键 API：
- `POST /backtests`：提交回测任务
- `GET /backtests/{id}`：查询状态
- `GET /backtests/{id}/results`：查询结果
- `POST /backtests/{id}/report`：生成报告
- `POST /parameter-sweeps`：提交参数扫描

### 8.3 回测结果结构
标准输出应包括：
- `equity_curve`
- `drawdown_curve`
- `orders`
- `fills`
- `positions`
- `metrics`
- `market_breakdown`
- `config_snapshot`

其中 `config_snapshot` 很关键，用于结果复现。

## 9. 正确性、风险与运维

### 9.1 核心风险
- 市场规则错误导致回测收益虚高或虚低
- 复权与公司行为处理错误导致价格序列失真
- 时区/夏令时处理不当导致信号错位
- 数据源口径不一致导致跨市场不可比
- 参数扫描任务过多导致资源争抢

### 9.2 风险控制措施
- 为每个市场建立回归测试样例
- 引入“已知结果”黄金样本回测
- 每次回测记录数据版本、代码版本、配置版本
- 对费率、税率、交易日历做版本化管理
- 对异常收益率结果设置告警阈值

### 9.3 审计与可复现
每次回测都必须存档：
- 策略代码版本
- 参数快照
- 数据版本
- 市场规则版本
- 引擎版本
- 报告生成时间

这决定了系统能否用于正式投研协作，而不只是个人实验。

## 10. 分阶段落地路线

### Phase 1: MVP（4-6 周）
目标：尽快形成可用研究闭环
- 支持日频回测
- 支持 A 股、港股、美股股票/ETF
- 支持统一策略接口
- 支持基础手续费/税费/复权
- 支持基本绩效报告
- 存储使用本地 Parquet + DuckDB

### Phase 2: 增强版（6-10 周）
- 增加分钟级回测
- 增加参数扫描与任务队列
- 增加更真实的滑点/成交量约束
- 增加 Web API 和报告中心
- 增加多币种净值折算

### Phase 3: 团队平台化
- 多用户权限
- 策略版本管理
- 回测结果缓存去重
- 集群执行
- 更丰富的因子归因与风险分析

## 11. 推荐的首版边界

为了控制复杂度，建议首版明确限制：

1. 资产范围仅限股票和 ETF，不先做期权/期货。
2. 先支持日频与分钟频，不先做 Tick 级。
3. 先支持单账户多市场，不先做复杂母子账户。
4. 先支持离线历史回测，不直接接入实盘交易。
5. 先支持研究回测，不把 OMS/EMS 做成生产交易系统。

这些限制能保证在满足核心需求的前提下，把系统做对、做稳。

## 12. 总结

该量化回测工具的核心，不是“把三个市场都接进来”，而是建立一个可扩展的统一抽象：

- 用标准化数据模型统一输入
- 用市场规则层承载差异
- 用统一回测内核保证执行一致性
- 用可复现的结果模型支撑研究、协作和审计

如果按该方案推进，首版就能覆盖 A 股、港股、美股的主流股票策略回测需求，并为后续的分钟级增强、参数扫描、团队化平台扩展留出清晰演进路径。
